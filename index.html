<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Finance Dash | v19.4 (Smart & Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --tag-bg: #334155; 
            --tag-text: #e2e8f0;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; 
            margin: 0; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-right: 1px solid #334155;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s;
            font-weight: 600;
            margin-bottom: 4px;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active { background: #1e293b; color: #60a5fa; }
        .nav-item svg { width: 20px; height: 20px; }

        /* SOCIAL ICONS */
        .social-row { display: flex; gap: 8px; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap; }
        .social-btn {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); color: #94a3b8;
            transition: all 0.2s; text-decoration: none;
        }
        .social-btn:hover { background: #3b82f6; color: white; transform: translateY(-2px); }

        /* GLASS CARDS */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: 24px;
            transition: transform 0.2s;
        }
        .glass-card:hover { transform: translateY(-2px); }

        /* UPLOAD AREA */
        .upload-zone { border: 2px dashed #475569; background: rgba(30, 41, 59, 0.5); transition: all 0.3s; }
        .upload-zone:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }

        /* KPI NUMBERS */
        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            background: -webkit-linear-gradient(45deg, #f8fafc, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* HEATMAP & LEGEND */
        .heatmap-container { display: flex; flex-wrap: wrap; gap: 4px; }
        .heat-day { width: 12px; height: 12px; border-radius: 3px; cursor: pointer; transition: transform 0.1s; border: 1px solid rgba(0,0,0,0.03); }
        .heat-day:hover { transform: scale(1.5); z-index: 10; border-color: #333; }
        
        .heatmap-legend { display: flex; gap: 12px; margin-top: 16px; font-size: 10px; font-weight: 700; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; }

        /* TABLA SORTABLE */
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background: rgba(255,255,255,0.05); }
        .cat-tag { background-color: var(--tag-bg); color: var(--tag-text); padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* TEXT COLORS OVERRIDES FOR DARK MODE */
        .text-slate-600 { color: #cbd5e1 !important; }
        .text-slate-700 { color: #e2e8f0 !important; }
        .text-slate-800 { color: #ffffff !important; }
        h1, h2, h3 { color: #ffffff !important; }
        
        thead { background-color: rgba(30, 41, 59, 0.9) !important; }
        th { color: #ffffff !important; }
        th.sortable:hover { background: rgba(255,255,255,0.1); }

        tbody tr { border-bottom-color: #334155 !important; }
        .bg-slate-50 { background-color: #1e293b !important; color: white !important; }
        .bg-white { background-color: transparent !important; }

        /* Fix para las opciones del desplegable */
        select option { background-color: #1e293b; color: #e2e8f0; }

        /* MOBILE */
        .mobile-overlay { display: none; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0 !important; }
            .mobile-overlay.open { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        }
    </style>
</head>
<body class="dark-mode dark">

    <!-- MEN√ö LATERAL -->
    <aside class="sidebar" id="sidebar">
        <div class="mb-8 flex items-center gap-3 px-2">
            <div class="relative w-10 h-10 flex items-center justify-center bg-blue-600 rounded-xl text-white font-bold text-xl shadow-lg shadow-blue-500/30">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight tracking-tight">Finance<span class="text-blue-600">Dash</span></h1>
                <p class="text-[10px] text-slate-400 font-semibold tracking-wider">V19.4 SMART</p>
            </div>
        </div>

        <nav class="flex-1">
            <a href="#" onclick="location.reload()" class="nav-item active">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                Dashboard
            </a>
            <div class="nav-item" id="btn-download-side">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Guardar App
            </div>
            <div class="nav-item hidden" id="btn-screenshot-side">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Exportar Foto
            </div>
        </nav>

        <div class="mt-auto pt-6 border-t border-slate-700">
            <div class="social-row">
                <a href="https://t.me/myfinancedash" target="_blank" class="social-btn" title="Telegram">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 11.944 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                </a>
                <a href="https://github.com/maxciber/myfinancedash" target="_blank" class="social-btn" title="GitHub">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                </a>
                <a href="https://x.com/myfinancedash" target="_blank" class="social-btn" title="Twitter/X">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>
                <a href="https://ko-fi.com/myfinancedash" target="_blank" class="social-btn" title="Ko-Fi">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.881 9.155c-.956-4.502-3.86-5.487-7.218-5.356-3.23.125-4.664 2.651-4.664 2.651s-1.391-2.522-4.665-2.651c-3.359-.131-6.262.854-7.218 5.356-.867 4.084 3.058 8.871 11.883 12.845 8.823-3.974 12.75-8.761 11.882-12.845z"/></svg>
                </a>
            </div>
        </div>
    </aside>

    <div class="mobile-overlay" id="mobile-overlay"></div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content flex-1 md:ml-[260px] p-4 md:p-8 transition-all duration-300">
        
        <!-- HEADER M√ìVIL (CORREGIDO) -->
        <div class="md:hidden flex justify-between items-center mb-6">
            <button id="btn-menu" class="p-2 rounded-lg bg-slate-800/50 backdrop-blur border border-slate-700 text-white hover:bg-slate-700/50 transition-colors">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <span class="font-bold text-slate-200">My Finance Dash</span>
            <div class="w-8"></div>
        </div>

        <!-- ZONA DE CARGA (Initial State) -->
        <div id="upload-area" class="max-w-2xl mx-auto mt-20 text-center">
            <div class="glass-card upload-zone p-12">
                <div class="w-24 h-24 bg-blue-100/50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-5xl">üìÇ</span>
                </div>
                <h2 class="text-3xl font-bold mb-3 text-slate-800 tracking-tight">Importa tus datos</h2>
                <p class="text-slate-500 mb-8 max-w-md mx-auto">Arrastra tu Excel aqu√≠. Tus datos nunca salen de este navegador.</p>
                <label class="inline-flex items-center justify-center px-8 py-4 text-base font-bold text-white transition-all duration-200 bg-blue-600 border border-transparent rounded-full shadow-lg hover:bg-blue-700 hover:shadow-blue-500/30 cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Seleccionar Excel
                    <input type="file" id="file-input" class="hidden" accept=".xls, .xlsx, .csv">
                </label>
            </div>
        </div>

        <!-- DASHBOARD (Hidden initially) -->
        <div id="dashboard" class="hidden max-w-6xl mx-auto space-y-6">
            
            <!-- CONTROLES SUPERIORES (UNIFICADO) -->
            <div class="glass-card flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white">Resumen Financiero</h2>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Vista general de tus movimientos</p>
                </div>
                <div class="flex items-center gap-3">
                    <div id="alert-partial" class="hidden px-3 py-1 bg-yellow-100 text-yellow-800 text-[10px] font-bold uppercase rounded-full border border-yellow-200">‚ö†Ô∏è Mes Actual</div>
                    <select id="month-selector" class="cursor-pointer bg-slate-800/50 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-semibold shadow-sm outline-none backdrop-blur-sm transition-colors hover:bg-slate-700/50">
                        <option value="all">Todo el Hist√≥rico</option>
                    </select>
                </div>
            </div>

            <!-- GRID KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-card relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">üí∏</div>
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Gastos Totales</p>
                    <div class="flex items-baseline gap-2"><p class="kpi-value text-slate-800" id="kpi-gastos">0 ‚Ç¨</p></div>
                    <div id="trend-gastos" class="mt-2 text-xs font-bold"></div>
                </div>
                <div class="glass-card relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">üí∞</div>
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Ingresos</p>
                    <div class="flex items-baseline gap-2"><p class="kpi-value text-slate-800" id="kpi-ingresos">0 ‚Ç¨</p></div>
                    <div id="trend-ingresos" class="mt-2 text-xs font-bold"></div>
                </div>
                <div class="glass-card relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-10 text-6xl">‚öñÔ∏è</div>
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Balance Neto</p>
                    <p class="kpi-value text-blue-600" id="kpi-balance">0 ‚Ç¨</p>
                </div>
                <div class="glass-card relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-10 text-6xl">üìÖ</div>
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Suscripciones</p>
                    <p class="kpi-value text-purple-600" id="kpi-subs">0</p>
                </div>
            </div>

            <!-- PAGOS DESGLOSADOS (UNIFICADO) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass-card flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase">Tarjetas / Google Pay</p>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400">Compras f√≠sicas y online</p>
                    </div>
                    <p class="text-2xl font-bold text-indigo-700 dark:text-indigo-300" id="kpi-tarjeta">0 ‚Ç¨</p>
                </div>
                <div class="glass-card flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-orange-600 dark:text-orange-400 uppercase">Transferencias</p>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400">Enviadas desde cuenta</p>
                    </div>
                    <p class="text-2xl font-bold text-orange-700 dark:text-orange-300" id="kpi-transfer">0 ‚Ç¨</p>
                </div>
            </div>

            <!-- HEATMAP -->
            <div class="glass-card">
                <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm flex items-center gap-2">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span> Intensidad de Gasto Diario
                </h3>
                <div id="heatmap" class="heatmap-container"></div>
                <!-- LEYENDA -->
                <div class="mt-4 flex gap-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 dark:text-slate-500">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-100 dark:bg-slate-800 rounded"></div> Sin Gasto</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-200 rounded"></div> Bajo</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-400 rounded"></div> Medio</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-600 rounded"></div> Alto</div>
                </div>
            </div>

            <!-- CHARTS ROW 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-card flex flex-col items-center justify-center p-6">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm w-full text-left">Tasa de Ahorro</h3>
                    <div class="relative w-48 h-48">
                        <canvas id="chart-gauge"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col mt-4">
                            <span class="text-3xl font-black text-slate-700 dark:text-white" id="gauge-percent">0%</span>
                            <span class="text-[10px] text-slate-400 uppercase font-bold">Ahorrado</span>
                        </div>
                    </div>
                </div>
                <div class="glass-card lg:col-span-2">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm">Distribuci√≥n por Categor√≠as</h3>
                    <div class="h-64 relative"><canvas id="chart-pie"></canvas></div>
                </div>
            </div>

            <!-- LINE CHART & SANKEY -->
            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm">Evoluci√≥n del Saldo</h3>
                    <div class="h-72 relative"><canvas id="chart-line"></canvas></div>
                </div>
                <div class="glass-card overflow-hidden">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm">Flujo de Dinero (Sankey)</h3>
                    <div id="sankey-container" style="width: 100%; height: 350px;"></div>
                </div>
            </div>

            <!-- TOP 5 GASTOS E INGRESOS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card">
                    <h3 class="font-bold text-red-600 dark:text-red-400 mb-4 text-sm uppercase flex items-center gap-2">üîª Top 5 Mayores Gastos</h3>
                    <div id="top-gastos-list" class="flex flex-col gap-2"></div>
                </div>
                <div class="glass-card">
                    <h3 class="font-bold text-green-600 dark:text-green-400 mb-4 text-sm uppercase flex items-center gap-2">üî∫ Top 5 Mayores Ingresos</h3>
                    <div id="top-ingresos-list" class="flex flex-col gap-2"></div>
                </div>
            </div>

            <!-- DETAILS TABLE (INTERACTIVE) -->
            <div class="glass-card overflow-hidden">
                <div class="flex justify-between items-center mb-6 px-2">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200">√öltimos Movimientos</h3>
                    <!-- BUSCADOR INTEGRADO (CORREGIDO SLATE-900) -->
                    <div class="flex items-center gap-2">
                        <input type="text" id="search-input" placeholder="Buscar..." class="bg-slate-100 dark:bg-slate-950 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-white text-xs rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all w-32 md:w-48">
                        <!-- BOT√ìN DE BORRAR FILTRO (Oculto por defecto) -->
                        <button id="btn-clear-filter" class="hidden text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition-colors flex items-center gap-2">
                            <span><span id="filter-name"></span></span>
                            <span>‚úñ</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px]">
                    <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                        <thead class="bg-slate-50/50 dark:bg-slate-700/50 text-slate-700 dark:text-slate-200 font-bold uppercase text-xs sticky top-0 backdrop-blur z-10">
                            <tr>
                                <th id="th-fecha" class="px-6 py-4 sortable hover:bg-white/20">Fecha <span class="sort-icon">‚ñº</span></th>
                                <th id="th-concepto" class="px-6 py-4 sortable hover:bg-white/20">Concepto <span class="sort-icon"></span></th>
                                <th id="th-categoria" class="px-6 py-4 sortable hover:bg-white/20">Categor√≠a <span class="sort-icon"></span></th>
                                <th id="th-importe" class="px-6 py-4 text-right sortable hover:bg-white/20">Importe <span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        const CONFIG = {
            categories: {
                'üõí Supermercado': ['mercadona', 'lidl', 'carrefour', 'dia', 'consum', 'alcampo', 'super', 'hipercor', 'ahorramas', 'aldi'],
                '‚õΩ Transporte': ['repsol', 'cepsa', 'galp', 'uber', 'cabify', 'renfe', 'gasolinera', 'shell', 'bp', 'taxi', 'emt', 'metro'],
                'üì∫ Suscripciones': ['netflix', 'spotify', 'hbo', 'disney', 'prime', 'google storage', 'gym', 'apple.com', 'dazn', 'skyshowtime', 'playstation', 'xbox'],
                'üçî Restauraci√≥n': ['restaurante', 'bar', 'cafe', 'mcdonalds', 'burger', 'glovo', 'just eat', 'vips', 'starbucks', 'foster', 'goiko', 'taco bell', 'domino', 'popeyes'],
                'üè† Hogar/Facturas': ['iberdrola', 'endesa', 'naturgy', 'agua', 'luz', 'gas', 'internet', 'vodafone', 'movistar', 'orange', 'digi', 'ikea', 'leroy', 'aki', 'bauhaus', 'bricomart'],
                'üì¶ Moda y Compras': ['amazon', 'aliexpress', 'zara', 'decathlon', 'primark', 'h&m', 'mango', 'shein', 'pull and bear', 'stradivarius', 'nike', 'adidas', 'fnac', 'casa del libro', 'primor', 'druni', 'sephora'],
                'üè• Salud y Ocio': ['farmacia', 'hospital', 'dentista', 'cine', 'entradas', 'ticketmaster', 'mutua', 'mapfre', 'allianz'],
                'üí≥ Digital/Bancos': ['bizum', 'paypal', 'transferencia', 'revolut', 'hipoteca', 'prestamo', 'comision', 'seguro']
            },
            colors: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#6366f1', '#a855f7', '#ec4899']
        };

        const UTILS = {
            fmtMoney: (n) => n.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }),
            parseDate: (val) => {
                if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000));
                if (typeof val === 'string') {
                    const parts = val.split('/');
                    if(parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]);
                }
                return new Date(val);
            },
            parseImporte: (val) => {
                let clean = String(val).replace(/[^\d,.-]/g, '').replace(',', '.');
                return parseFloat(clean);
            }
        };

        let rawDataStore = null; 
        let sortConfig = { key: 'fecha', desc: true };
        let activeCategoryFilter = null; 
        let activeSearchTerm = ''; 

        const DataEngine = {
            detectColumns: (rows) => {
                let colMap = { fecha: -1, concepto: -1, importe: -1 };
                let startIdx = -1;
                for (let i = 0; i < rows.length; i++) {
                    const rowStr = rows[i].join(' ').toLowerCase();
                    if ((rowStr.includes('concepto') || rowStr.includes('descripci√≥n')) && rowStr.includes('importe')) {
                        rows[i].forEach((cell, idx) => {
                            const txt = String(cell).toLowerCase().trim();
                            if (txt.includes('fecha')) colMap.fecha = idx;
                            if (txt.includes('operativa') && colMap.fecha === -1) colMap.fecha = idx;
                            if (txt.includes('concepto') || txt.includes('descripci√≥n')) colMap.concepto = idx;
                            if (txt.includes('importe')) colMap.importe = idx;
                        });
                        startIdx = i + 1; break;
                    }
                }
                return { colMap, startIdx };
            },
            processRows: (rows) => {
                const { colMap, startIdx } = DataEngine.detectColumns(rows);
                if (startIdx === -1) return null;
                
                let allMovs = [];
                let monthsSet = new Set();

                for (let i = startIdx; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row[colMap.concepto] || !row[colMap.importe]) continue;
                    let desc = String(row[colMap.concepto]);
                    let importe = UTILS.parseImporte(row[colMap.importe]);
                    if (isNaN(importe)) continue;
                    let cat = 'üìÇ Otros';
                    let dateObj = UTILS.parseDate(row[colMap.fecha]);
                    let fechaStr = dateObj.toLocaleDateString('es-ES');
                    let monthKey = dateObj.toISOString().slice(0, 7); // YYYY-MM
                    
                    monthsSet.add(monthKey);

                    let lowerDesc = desc.toLowerCase();
                    if (importe < 0) {
                        for (const [k, v] of Object.entries(CONFIG.categories)) { if (v.some(kw => lowerDesc.includes(kw))) { cat = k; break; } }
                    } else {
                        cat = 'üí∞ Ingresos';
                    }
                    allMovs.push({ dateObj, fecha: fechaStr, desc, cat, importe, monthKey });
                }
                return { movs: allMovs, months: Array.from(monthsSet).sort().reverse() };
            },
            calculateStats: (movs) => {
                let stats = { ing: 0, gas: 0, subs: 0, card: 0, trans: 0 };
                let catTotals = {};
                let ranking = {};
                let dailyGas = {};
                
                movs.forEach(m => {
                    if (m.importe < 0) {
                        stats.gas += Math.abs(m.importe);
                        if (m.cat.includes('Suscripciones')) stats.subs++;
                        if (['tarjeta', 'pay', 'bizum', 'compra'].some(k => m.desc.toLowerCase().includes(k))) stats.card += Math.abs(m.importe); else stats.trans += Math.abs(m.importe);
                        catTotals[m.cat] = (catTotals[m.cat] || 0) + Math.abs(m.importe);
                        dailyGas[m.fecha] = (dailyGas[m.fecha] || 0) + Math.abs(m.importe);
                    } else {
                        stats.ing += m.importe;
                    }
                    ranking[m.desc.substring(0, 25).toUpperCase()] = (ranking[m.desc.substring(0, 25).toUpperCase()] || 0) + m.importe;
                });
                return { stats, catTotals, dailyGas, ranking };
            }
        };

        const UI = {
            charts: {},
            toggleDarkMode: () => { document.body.classList.toggle('dark-mode'); },
            toggleMobileMenu: () => {
                document.getElementById('sidebar').classList.toggle('open');
                document.getElementById('mobile-overlay').classList.toggle('open');
            },
            downloadApp: () => {
                const html = document.documentElement.outerHTML;
                const blob = new Blob([html], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'MyFinance_Dash_v18.html';
                a.click();
            },
            sortData: (key) => {
                if (sortConfig.key === key) {
                    sortConfig.desc = !sortConfig.desc;
                } else {
                    sortConfig.key = key;
                    sortConfig.desc = true;
                }
                const factor = sortConfig.desc ? -1 : 1;
                // Usamos la funci√≥n que respeta el filtro de categor√≠a
                const currentMovs = App.getMovsForTable(); 
                currentMovs.sort((a, b) => {
                    if (key === 'fecha') return (a.dateObj - b.dateObj) * factor;
                    if (key === 'importe') return (a.importe - b.importe) * factor;
                    if (key === 'concepto') return a.desc.localeCompare(b.desc) * factor;
                    if (key === 'categoria') return a.cat.localeCompare(b.cat) * factor;
                    return 0;
                });
                
                document.querySelectorAll('.sort-icon').forEach(el => el.innerText = '');
                const mapId = { 'fecha': 'th-fecha', 'importe': 'th-importe', 'concepto': 'th-concepto', 'categoria': 'th-categoria' };
                const target = mapId[key];
                if(target) document.querySelector(`#${target} .sort-icon`).innerText = sortConfig.desc ? ' ‚ñº' : ' ‚ñ≤';

                UI.renderTable(currentMovs);
            },
            showDashboard: () => { 
                document.getElementById('upload-area').classList.add('hidden'); 
                document.getElementById('dashboard').classList.remove('hidden'); 
            },
            updateKPIs: (stats, prevStats = null) => {
                document.getElementById('kpi-gastos').innerText = UTILS.fmtMoney(stats.gas);
                document.getElementById('kpi-ingresos').innerText = UTILS.fmtMoney(stats.ing);
                document.getElementById('kpi-balance').innerText = UTILS.fmtMoney(stats.ing - stats.gas);
                document.getElementById('kpi-subs').innerText = stats.subs;
                document.getElementById('kpi-tarjeta').innerText = UTILS.fmtMoney(stats.card);
                document.getElementById('kpi-transfer').innerText = UTILS.fmtMoney(stats.trans);

                const setTrend = (id, current, prev, isBadIfUp) => {
                    const el = document.getElementById(id);
                    if (!prev || prev === 0) { el.innerHTML = ''; return; }
                    const diff = ((current - prev) / prev) * 100;
                    if (Math.abs(diff) < 1) { el.innerHTML = ''; return; }
                    const isUp = diff > 0;
                    const isBad = isBadIfUp ? isUp : !isUp;
                    const color = isBad ? 'text-red-500' : 'text-green-500';
                    const arrow = isUp ? '‚Üë' : '‚Üì';
                    el.innerHTML = `<span class="${color}">${arrow} ${Math.abs(diff).toFixed(1)}% vs mes ant.</span>`;
                };

                if (prevStats) {
                    setTrend('trend-gastos', stats.gas, prevStats.gas, true);
                    setTrend('trend-ingresos', stats.ing, prevStats.ing, false);
                } else {
                    document.getElementById('trend-gastos').innerHTML = '';
                    document.getElementById('trend-ingresos').innerHTML = '';
                }

                const tasa = stats.ing > 0 ? Math.max(0, ((stats.ing - stats.gas) / stats.ing) * 100) : 0;
                document.getElementById('gauge-percent').innerText = `${Math.round(tasa)}%`;
                return tasa;
            },
            renderTop5: (ranking) => {
                const rankArr = Object.entries(ranking).map(([k, v]) => ({ name: k, total: v }));
                const topG = rankArr.filter(x => x.total < 0).sort((a, b) => a.total - b.total).slice(0, 5);
                const topI = rankArr.filter(x => x.total > 0).sort((a, b) => b.total - a.total).slice(0, 5);
                const rowH = (i, c) => `<div class="flex justify-between py-2 border-b dark:border-slate-700/50 text-xs"><span class="truncate w-2/3 font-semibold uppercase opacity-80">${i.name}</span><span class="font-bold ${c}">${UTILS.fmtMoney(i.total)}</span></div>`;
                document.getElementById('top-gastos-list').innerHTML = topG.map(x => rowH(x, 'text-red-500')).join('');
                document.getElementById('top-ingresos-list').innerHTML = topI.map(x => rowH(x, 'text-green-500')).join('');
            },
            renderTable: (movs) => {
                const html = movs.map(m => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                        <td class="px-6 py-4 text-xs font-mono opacity-80">${m.fecha}</td>
                        <td class="px-6 py-4 font-medium text-slate-700 dark:text-slate-200 cursor-pointer" onclick="this.querySelector('div').classList.toggle('truncate'); this.querySelector('div').classList.toggle('whitespace-normal');" title="Clic para expandir/contraer">
                            <div class="truncate max-w-[300px] transition-all duration-200">${m.desc}</div>
                        </td>
                        <td class="px-6 py-4 text-xs"><span class="cat-tag">${m.cat}</span></td>
                        <td class="px-6 py-4 text-right font-bold ${m.importe >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-500 dark:text-red-400'}">${UTILS.fmtMoney(m.importe)}</td>
                    </tr>
                `).join('');
                document.getElementById('table-body').innerHTML = html;
            },
            renderHeatmap: (dailyGas) => {
                const heatDiv = document.getElementById('heatmap'); heatDiv.innerHTML = '';
                const sel = document.getElementById('month-selector').value;
                let loopDays = 90;
                if(sel !== 'all') loopDays = 31; 

                for (let i = loopDays; i >= 0; i--) {
                   let d = new Date(); 
                   if(sel !== 'all') { d = new Date(sel + '-01'); d.setDate(d.getDate() + (31-i)); }
                   else { d.setDate(d.getDate() - i); }
                   let ds = d.toLocaleDateString('es-ES');
                   let val = dailyGas[ds] || 0;
                   // CORRECCI√ìN: Cuadros vac√≠os m√°s oscuros (slate-800)
                   let color = val > 120 ? 'bg-red-600' : val > 40 ? 'bg-red-400' : val > 0 ? 'bg-red-200' : 'bg-slate-100 dark:bg-slate-800';
                   let dayEl = document.createElement('div'); dayEl.className = `heat-day ${color}`; dayEl.title = `${ds}: ${UTILS.fmtMoney(val)}`;
                   heatDiv.appendChild(dayEl);
                }
            },
            renderCharts: (stats, catTotals, movs, tasaAhorro) => {
                ['chart-gauge', 'chart-pie', 'chart-line'].forEach(id => { if (UI.charts[id]) UI.charts[id].destroy(); });
                
                const isDark = document.body.classList.contains('dark-mode');
                const txtColor = isDark ? '#e2e8f0' : '#334155';
                const gridColor = isDark ? '#334155' : '#e2e8f0';

                UI.charts['chart-gauge'] = new Chart(document.getElementById('chart-gauge'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [tasaAhorro, 100 - tasaAhorro], backgroundColor: ['#3b82f6', isDark ? '#1e293b' : '#e2e8f0'], borderWidth: 0, circumference: 180, rotation: 270, cutout: '85%' }] },
                    options: { maintainAspectRatio: false, plugins: { tooltip: { enabled: false } } }
                });
                
                // PIE CHART INTERACTIVO
                UI.charts['chart-pie'] = new Chart(document.getElementById('chart-pie'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(catTotals), datasets: [{ data: Object.values(catTotals), backgroundColor: CONFIG.colors, borderWidth: 0, hoverOffset: 10 }] },
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { legend: { position: 'right', labels: { color: txtColor, boxWidth: 12, padding: 15, font: {size: 11} } } }, 
                        cutout: '70%',
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const label = UI.charts['chart-pie'].data.labels[index];
                                App.applyCategoryFilter(label);
				document.querySelector('table').scrollIntoView({ behavior: 'smooth' });
                            }
                        }
                    }
                });

                const cronoMovs = [...movs].sort((a,b) => a.dateObj - b.dateObj);
                let acc = 0; const pts = cronoMovs.map(m => { acc += m.importe; return acc; });
                
                UI.charts['chart-line'] = new Chart(document.getElementById('chart-line'), {
                    type: 'line',
                    data: { labels: cronoMovs.map(m => m.fecha.substring(0, 5)), datasets: [{ label: 'Saldo', data: pts, borderColor: '#3b82f6', borderWidth: 3, tension: 0.3, pointRadius: 0, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] },
                    options: { 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { ticks: { color: txtColor, font: {size: 10} }, grid: { color: gridColor, borderDash: [5,5] } }, 
                            x: { ticks: { color: txtColor, font: {size: 10} }, grid: { display: false } } 
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                google.charts.setOnLoadCallback(() => {
                    const data = new google.visualization.DataTable();
                    data.addColumn('string', 'From'); data.addColumn('string', 'To'); data.addColumn('number', 'Importe');
                    const rows = [['Ingresos', 'Total', Math.round(stats.ing)]];
                    for (const [cat, total] of Object.entries(catTotals)) { rows.push(['Total', cat, Math.round(total)]); }
                    if (stats.ing - stats.gas > 0) rows.push(['Total', 'Ahorro', Math.round(stats.ing - stats.gas)]);
                    data.addRows(rows);
                    const sankeyColors = isDark ? '#94a3b8' : '#334155';
                    new google.visualization.Sankey(document.getElementById('sankey-container')).draw(data, { sankey: { node: { label: { fontSize: 11, fontWeight: 'bold', color: sankeyColors }, nodePadding: 20 }, link: { colorMode: 'gradient' } } });
                });
            }
        };

        const App = {
            init: () => {
                google.charts.load('current', {'packages':['sankey']});
                App.setupListeners();
            },
            getCurrentFilteredMovs: () => {
                if(!rawDataStore) return [];
                const sel = document.getElementById('month-selector').value;
                if (sel === 'all') return rawDataStore.movs;
                return rawDataStore.movs.filter(m => m.monthKey === sel);
            },
            getMovsForTable: () => {
                let movs = App.getCurrentFilteredMovs();
                if (activeCategoryFilter) {
                    movs = movs.filter(m => m.cat === activeCategoryFilter);
                }
                if (activeSearchTerm) {
                    const term = activeSearchTerm.toLowerCase();
                    movs = movs.filter(m => 
                        m.desc.toLowerCase().includes(term) || 
                        m.cat.toLowerCase().includes(term) ||
                        m.importe.toString().includes(term)
                    );
                }
                return movs;
            },
            updateFilterBadge: () => {
                const filtered = App.getMovsForTable();
                if (activeSearchTerm || activeCategoryFilter) {
                    let total = 0;
                    filtered.forEach(m => total += m.importe);
                    let label = activeCategoryFilter ? activeCategoryFilter : `"${activeSearchTerm}"`;
                    if (activeCategoryFilter && activeSearchTerm) label = `${activeCategoryFilter} + "${activeSearchTerm}"`;
                    document.getElementById('filter-name').innerText = `${label} | ${filtered.length} movs | Total: ${UTILS.fmtMoney(total)}`;
                    document.getElementById('btn-clear-filter').classList.remove('hidden');
                } else {
                    document.getElementById('btn-clear-filter').classList.add('hidden');
                }
            },
            applyCategoryFilter: (category) => {
                activeCategoryFilter = category;
                App.updateFilterBadge();
                UI.renderTable(App.getMovsForTable());
            },
            clearCategoryFilter: () => {
                activeCategoryFilter = null;
                activeSearchTerm = '';
                document.getElementById('search-input').value = '';
                document.getElementById('btn-clear-filter').classList.add('hidden');
                UI.renderTable(App.getMovsForTable());
            },
            refreshDashboard: () => {
                App.clearCategoryFilter();
                const movs = App.getCurrentFilteredMovs();
                const processed = DataEngine.calculateStats(movs);
                const sel = document.getElementById('month-selector').value;
                let prevStats = null;
                const currentYM = new Date().toISOString().slice(0, 7);
                const alertEl = document.getElementById('alert-partial');
                if (sel === currentYM) alertEl.classList.remove('hidden'); else alertEl.classList.add('hidden');
                if (sel !== 'all') {
                    let [y, m] = sel.split('-').map(Number);
                    m--; if (m === 0) { m = 12; y--; }
                    const prevKey = `${y}-${String(m).padStart(2, '0')}`;
                    const prevMovs = rawDataStore.movs.filter(k => k.monthKey === prevKey);
                    if (prevMovs.length > 0) prevStats = DataEngine.calculateStats(prevMovs).stats;
                }
                const tasaAhorro = UI.updateKPIs(processed.stats, prevStats);
                UI.renderHeatmap(processed.dailyGas);
                UI.renderTop5(processed.ranking);
                UI.renderCharts(processed.stats, processed.catTotals, movs, tasaAhorro);
                UI.renderTable(movs);
            },
            setupListeners: () => {
                document.getElementById('btn-download-side').addEventListener('click', UI.downloadApp);
                document.getElementById('btn-menu').addEventListener('click', UI.toggleMobileMenu);
                document.getElementById('mobile-overlay').addEventListener('click', UI.toggleMobileMenu);
                document.getElementById('month-selector').addEventListener('change', App.refreshDashboard);
                document.getElementById('th-fecha').addEventListener('click', () => UI.sortData('fecha'));
                document.getElementById('th-importe').addEventListener('click', () => UI.sortData('importe'));
                document.getElementById('th-concepto').addEventListener('click', () => UI.sortData('concepto'));
                document.getElementById('th-categoria').addEventListener('click', () => UI.sortData('categoria'));
                document.getElementById('btn-clear-filter').addEventListener('click', App.clearCategoryFilter);
                document.getElementById('search-input').addEventListener('input', (e) => {
                    activeSearchTerm = e.target.value;
                    App.updateFilterBadge();
                    UI.renderTable(App.getMovsForTable());
                });
                document.getElementById('file-input').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const r = new FileReader();
                    r.onload = ev => {
                        const rows = XLSX.utils.sheet_to_json(XLSX.read(ev.target.result, { type: 'array' }).Sheets[XLSX.read(ev.target.result, { type: 'array' }).SheetNames[0]], { header: 1, defval: '' });
                        const processedData = DataEngine.processRows(rows);
                        if (processedData) { 
                            rawDataStore = processedData; 
                            const sel = document.getElementById('month-selector');
                            sel.innerHTML = '<option value="all">Todo el Hist√≥rico</option>';
                            processedData.months.forEach(m => {
                                const opt = document.createElement('option');
                                opt.value = m;
                                const [y, mon] = m.split('-');
                                const dateName = new Date(y, mon-1).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                                opt.innerText = dateName.charAt(0).toUpperCase() + dateName.slice(1);
                                sel.appendChild(opt);
                            });
                            UI.showDashboard();
                            App.refreshDashboard();
                            document.getElementById('btn-screenshot-side').classList.remove('hidden');
                        }
                    };
                    r.readAsArrayBuffer(file);
                });
                document.getElementById('btn-screenshot-side').addEventListener('click', async () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.style.display = 'none';
                    const canvas = await html2canvas(document.body, { backgroundColor: document.body.classList.contains('dark-mode') ? '#0f172a' : '#f0f9ff' });
                    const link = document.createElement('a'); link.download = `MyFinance_Report.png`; link.href = canvas.toDataURL(); link.click();
                    sidebar.style.display = '';
                });
            }
        };

        App.init();
    </script>
</body>
</html>
